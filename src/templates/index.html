<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Container Manager | DSA EL</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Toned Down Sunset Theme */
            --bg-base: #2b102f;
            --bg-gradient-start: #2b102f;
            --bg-gradient-end: #200f21;
            
            --glass-bg: rgba(255, 255, 255, 0.05); /* Lighter glass */
            --glass-border: rgba(255, 255, 255, 0.1);
            
            --accent-primary: #ff6a00;
            --accent-secondary: #ee0979;
            
            --text-main: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.6);
        }
        
        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            color: var(--text-main);
            min-height: 100vh;
            overflow: hidden; 
        }

        /* Ambient Orbs */
        .orb {
            position: fixed;
            border-radius: 50%;
            filter: blur(100px);
            z-index: -50;
            opacity: 0.25;
            animation: pulse 10s infinite alternate;
        }
        .orb-1 { top: -20%; left: -10%; width: 60vw; height: 60vw; background: var(--accent-primary); }
        .orb-2 { bottom: -20%; right: -10%; width: 60vw; height: 60vw; background: var(--accent-secondary); }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.2; }
            100% { transform: scale(1.1); opacity: 0.3; }
        }

        /* Glassmorphism */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
        }

        /* Sidebar Item */
        .nav-item {
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            color: var(--text-muted);
        }
        .nav-item:hover, .nav-item.active {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
        }
        .nav-item.active {
            border-left-color: var(--accent-primary);
            background: linear-gradient(90deg, rgba(255, 106, 0, 0.1) 0%, transparent 100%);
        }

        /* Gradient Text */
        .text-gradient {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Terminal Logs */
        .terminal-log {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
        }
        .log-entry {
            border-left: 2px solid rgba(255,255,255,0.2);
            padding-left: 0.75rem;
            margin-bottom: 0.5rem;
            opacity: 0;
            animation: slideIn 0.3s forwards;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Button Gradient */
        .btn-sunset {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            transition: opacity 0.2s;
        }
        .btn-sunset:hover { opacity: 0.9; box-shadow: 0 0 15px rgba(255, 106, 0, 0.4); }
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen">

    <!-- Orbs -->
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>

    <!-- Sidebar -->
    <aside class="w-full md:w-64 glass-panel flex flex-col z-20 md:h-full border-r border-white/10">
        <div class="p-6">
            <h1 class="text-2xl font-bold tracking-tight text-white flex items-center gap-2">
                <span class="text-3xl text-gradient">âŒ˜</span> DSA EL
            </h1>
            <p class="text-xs text-white/50 mt-1 uppercase tracking-widest">OS Intelligence</p>
        </div>
        
        <nav class="flex-1 space-y-1 mt-4">
            <button onclick="switchView('overview')" id="nav-overview" class="nav-item w-full text-left px-6 py-4 flex items-center gap-3 active">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                Overview
            </button>
            <button onclick="switchView('intelligence')" id="nav-intelligence" class="nav-item w-full text-left px-6 py-4 flex items-center gap-3">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                Intelligence
            </button>
            <button onclick="switchView('lab')" id="nav-lab" class="nav-item w-full text-left px-6 py-4 flex items-center gap-3">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                Simulation Lab
            </button>
        </nav>

        <div class="p-6">
            <div class="glass-panel p-4 rounded-xl bg-white/5 border-0">
                <div class="text-xs text-white/40 mb-1">Status</div>
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse shadow-[0_0_8px_rgba(74,222,128,0.6)]"></span>
                    <span class="text-sm font-semibold text-white">System Active</span>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto relative z-10 p-6 md:p-10">
        
        <!-- View: Overview -->
        <section id="view-overview" class="space-y-6 animate-fade-in block">
            <header class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-white drop-shadow-sm">System Overview</h2>
                    <p class="text-white/50">Real-time Node Telemetry</p>
                </div>
                <div id="sim-badge" class="hidden px-3 py-1 bg-gradient-to-r from-orange-500/20 to-pink-500/20 border border-orange-500/30 rounded-full text-xs font-bold text-orange-200 uppercase tracking-wider animate-pulse">
                    Simulation Active
                </div>
            </header>

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                 <div class="glass-panel p-6 rounded-2xl">
                     <div class="text-white/40 text-xs uppercase mb-2">Total CPU Load</div>
                     <div id="metric-cpu" class="text-4xl font-bold text-white">--</div>
                 </div>
                 <div class="glass-panel p-6 rounded-2xl">
                     <div class="text-white/40 text-xs uppercase mb-2">Active Nodes</div>
                     <div id="metric-nodes" class="text-4xl font-bold text-white">--</div>
                 </div>
                 <div class="glass-panel p-6 rounded-2xl">
                     <div class="text-white/40 text-xs uppercase mb-2">Containers</div>
                     <div id="metric-containers" class="text-4xl font-bold text-white">--</div>
                 </div>
                 <div class="glass-panel p-6 rounded-2xl border-orange-500/30">
                     <div class="text-orange-300 text-xs uppercase mb-2">Security Score</div>
                     <div id="metric-security" class="text-4xl font-bold text-gradient">--</div>
                 </div>
            </div>

            <div class="flex flex-col md:flex-row gap-6 h-[450px]">
                <!-- Node Monitor -->
                <div class="w-full md:w-1/3 glass-panel rounded-2xl p-6 flex flex-col">
                    <h3 class="text-lg font-bold text-white mb-4">Active Containers</h3>
                    <div id="container-list" class="flex-1 overflow-y-auto space-y-2 pr-2">
                        <!-- Items -->
                    </div>
                </div>

                <!-- Main Chart -->
                <div class="w-full md:w-2/3 glass-panel rounded-2xl p-6 flex flex-col">
                    <h3 class="text-lg font-bold text-white mb-4">Resource Prediction</h3>
                    <div class="flex-1 relative w-full">
                        <canvas id="resourceChart"></canvas>
                    </div>
                </div>
            </div>
        </section>


        <!-- View: Intelligence -->
        <section id="view-intelligence" class="space-y-6 animate-fade-in hidden h-full flex flex-col">
            <header class="mb-4">
                <h2 class="text-3xl font-bold text-white">Neural Intelligence Log</h2>
                <p class="text-white/50">Real-time decisions from the Governance Engine</p>
            </header>

            <div class="flex-1 glass-panel rounded-2xl p-6 overflow-hidden flex flex-col bg-black/20">
                <div class="flex items-center gap-2 mb-4 pb-4 border-b border-white/5">
                    <div class="w-3 h-3 rounded-full bg-red-500/80"></div>
                    <div class="w-3 h-3 rounded-full bg-yellow-500/80"></div>
                    <div class="w-3 h-3 rounded-full bg-green-500/80"></div>
                    <span class="ml-2 text-xs text-white/30 font-mono">system_events.log</span>
                </div>
                
                <div id="event-log-container" class="flex-1 overflow-y-auto terminal-log space-y-2 pr-2">
                    <div class="text-white/30">// Waiting for system events...</div>
                </div>
            </div>
        </section>


        <!-- View: Lab -->
        <section id="view-lab" class="space-y-6 animate-fade-in hidden">
            <header class="mb-8">
                <h2 class="text-3xl font-bold text-white">Simulation Lab</h2>
                <p class="text-white/50">Test constraints and run attack scenarios</p>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Simulator Control -->
                <div class="glass-panel rounded-2xl p-8">
                    <h3 class="text-xl font-bold text-white mb-6">Live Simulation</h3>
                    <p class="text-sm text-white/60 mb-6">
                        Inject synthetic traffic patterns and security threats to verify autonomous response without physical infrastructure.
                    </p>
                    
                    <div class="space-y-4">
                        <div class="flex gap-4">
                            <button onclick="controlSim('start')" class="flex-1 btn-sunset text-white font-bold py-3 rounded-xl shadow-lg shadow-orange-500/20">
                                Start Simulation
                            </button>
                            <button onclick="controlSim('stop')" class="flex-1 glass-panel text-white font-bold py-3 rounded-xl hover:bg-white/5">
                                Stop
                            </button>
                        </div>
                        
                        <div class="pt-6 border-t border-white/10">
                            <label class="text-xs text-white/40 uppercase font-bold">Scenario Mode</label>
                            <div class="grid grid-cols-3 gap-2 mt-2">
                                <button onclick="setSimMode('normal')" class="p-2 rounded-lg bg-white/5 text-xs text-white/70 hover:text-white hover:bg-white/10 transition text-center">Normal Load</button>
                                <button onclick="setSimMode('spike')" class="p-2 rounded-lg bg-white/5 text-xs text-white/70 hover:text-white hover:bg-white/10 transition text-center">Spike Test</button>
                                <button onclick="setSimMode('attack')" class="p-2 rounded-lg bg-red-500/10 text-xs text-red-300 hover:bg-red-500/20 transition text-center border border-red-500/10">Active Attack</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Evaluation -->
                <div class="glass-panel rounded-2xl p-8">
                    <h3 class="text-xl font-bold text-white mb-6">Efficiency Comparison</h3>
                    <button onclick="runEvaluation()" class="w-full glass-panel border border-white/10 text-orange-200 py-3 rounded-xl mb-4 hover:bg-white/5 transition">
                        Run Static vs Dynamic Analysis
                    </button>
                    
                    <div id="eval-loading" class="hidden text-center text-xs text-white/50 py-2 animate-pulse">Processing...</div>

                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-white/40 uppercase">
                            <tr>
                                <th class="py-2">Mode</th>
                                <th class="py-2">Efficiency</th>
                                <th class="py-2">OOM Kills</th>
                            </tr>
                        </thead>
                        <tbody id="eval-body" class="text-white/80">
                            <tr><td colspan="3" class="py-4 text-center text-white/30 italic">No data available</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>

    <script>
        // --- Navigation ---
        function switchView(viewName) {
            ['overview', 'intelligence', 'lab'].forEach(v => {
                document.getElementById(`view-${v}`).classList.add('hidden');
                document.getElementById(`nav-${v}`).classList.remove('active');
            });
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            document.getElementById(`nav-${viewName}`).classList.add('active');
            
            if(viewName === 'overview') resourceChart.resize();
        }

        // --- Chart Setup ---
        Chart.defaults.color = 'rgba(255, 255, 255, 0.5)';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.05)';
        const ctx = document.getElementById('resourceChart').getContext('2d');
        let gradient = ctx.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, 'rgba(255, 106, 0, 0.4)'); 
        gradient.addColorStop(1, 'rgba(255, 106, 0, 0.0)');

        const resourceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'CPU Usage',
                    data: [],
                    borderColor: '#ff6a00',
                    backgroundColor: gradient,
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0
                }, {
                    label: 'Limit',
                    data: [],
                    borderColor: 'rgba(255, 255, 255, 0.3)',
                    borderWidth: 1,
                    borderDash: [4, 4],
                    pointRadius: 0,
                    tension: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { 
                    x: { display: false },
                    y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } }
                }
            }
        });

        // --- Data Fetching ---
        let selectedContainer = null;
        let logsSeen = new Set();

        async function refresh() {
            try {
                // 1. Stats
                const statsRes = await fetch('/api/stats');
                const nodes = await statsRes.json();
                updateOverview(nodes);

                // 2. Logs
                const logsRes = await fetch('/api/events');
                const logs = await logsRes.json();
                updateLogs(logs);

            } catch(e) { }
        }

        function updateOverview(nodes) {
            const listEl = document.getElementById('container-list');
            
            let totalCpu = 0;
            let totalNodes = Object.keys(nodes).length;
            let totalContainers = 0;

            // Simple diffing
            listEl.innerHTML = ''; 

            Object.entries(nodes).forEach(([nodeId, data]) => {
                if (nodeId.includes('sim')) document.getElementById('sim-badge').classList.remove('hidden');

                Object.entries(data.containers).forEach(([cId, stats]) => {
                    totalContainers++;
                    totalCpu += stats.cpu_usage || 0;
                    
                    const isSel = selectedContainer === cId;
                    const el = document.createElement('div');
                    el.className = `p-3 rounded-xl border cursor-pointer flex justify-between items-center transition mb-2
                        ${isSel ? 'bg-white/10 border-orange-500/40 shadow-lg' : 'bg-white/5 border-transparent hover:bg-white/10'}`;
                    el.onclick = () => { selectedContainer = cId; updateChartData(stats); };
                    el.innerHTML = `
                        <div class="text-sm font-bold text-white truncate w-32">${cId}</div>
                        <div class="text-xs text-white/60">${Math.round(stats.cpu_usage/1000)}k</div>
                    `;
                    listEl.appendChild(el);

                    if (isSel) updateChartData(stats);
                });
            });

            document.getElementById('metric-nodes').innerText = totalNodes;
            document.getElementById('metric-containers').innerText = totalContainers;
            document.getElementById('metric-cpu').innerText = Math.round(totalCpu/1000000) + 'M';
            document.getElementById('metric-security').innerText = '98'; 

            if (!selectedContainer && totalContainers > 0) {
                 const firstNode = Object.values(nodes)[0];
                 const firstC = Object.keys(firstNode.containers)[0];
                 if(firstC) selectedContainer = firstC;
            }
        }

        function updateChartData(stats) {
            const time = new Date().toLocaleTimeString();
            if (resourceChart.data.labels.length > 40) {
                resourceChart.data.labels.shift();
                resourceChart.data.datasets[0].data.shift();
                resourceChart.data.datasets[1].data.shift();
            }
            resourceChart.data.labels.push(time);
            resourceChart.data.datasets[0].data.push(stats.cpu_usage);
            resourceChart.data.datasets[1].data.push(stats.prediction);
            resourceChart.update('none');
        }

        function updateLogs(logs) {
            const container = document.getElementById('event-log-container');
            const latest = logs[0];
            if (!latest) return;
            
            const key = latest.timestamp + latest.message;
            if (logsSeen.has(key)) return;
            
            if (container.children.length > 20) container.innerHTML = '';

            logs.forEach(log => {
                const k = log.timestamp + log.message;
                if (logsSeen.has(k)) return;
                logsSeen.add(k);

                const el = document.createElement('div');
                el.className = 'log-entry';
                
                let color = 'text-white/80';
                if (log.level === 'WARNING') { color = 'text-yellow-400'; el.style.borderLeftColor = '#facc15'; }
                if (log.level === 'CRITICAL') { color = 'text-red-400'; el.style.borderLeftColor = '#f87171'; }
                if (log.level === 'SUCCESS') { color = 'text-green-400'; el.style.borderLeftColor = '#4ade80'; }

                el.innerHTML = `
                    <span class="text-white/30 text-xs">[${log.timestamp}]</span>
                    <span class="font-bold text-xs uppercase ml-1 ${color}">${log.source}</span>
                    <span class="text-white/60 ml-2">${log.message}</span>
                `;
                container.prepend(el);
            });
        }

        // --- Controls ---
        async function controlSim(action) { await fetch(`/api/simulation/${action}`, { method: 'POST' }); }
        async function setSimMode(mode) { await fetch(`/api/simulation/mode?mode=${mode}`, { method: 'POST' }); }
        async function runEvaluation() {
            const btn = document.querySelector('#view-lab button');
            const loader = document.getElementById('eval-loading');
            btn.disabled = true; loader.classList.remove('hidden');
            try {
                const res = await fetch('/api/run_evaluation');
                const data = await res.json();
                const tbody = document.getElementById('eval-body'); tbody.innerHTML = '';
                data.forEach(row => {
                    tbody.innerHTML += `<tr class="border-b border-white/5 hover:bg-white/5"><td class="py-3 pl-2">${row.Mode}</td><td>${row.Efficiency_Percent}%</td><td class="${row.OOM_Kills>0?'text-red-400':''}">${row.OOM_Kills}</td></tr>`;
                });
            } catch(e) {}
            btn.disabled = false; loader.classList.add('hidden');
        }

        setInterval(refresh, 1000);
        refresh();
    </script>
</body>
</html>
