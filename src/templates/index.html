<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Container Manager</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            /* Sunset Orange Gradient */
            background: linear-gradient(135deg, #FF512F 0%, #DD2476 100%); 
            background-attachment: fixed;
            color: #fff;
            min-height: 100vh;
        }

        /* Enhanced Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .glass-card:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1); 
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3); 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5); 
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto animate-fade-in">
        <!-- Header -->
        <header class="mb-8 flex justify-between items-center glass p-6 rounded-3xl">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-white drop-shadow-md">
                    Smart OS <span class="text-orange-200">Manager</span>
                </h1>
                <p class="text-pink-100 opacity-90 text-sm md:text-base mt-1">Autonomous Kernel-Level Orchestration</p>
            </div>
            <div class="text-right hidden md:block">
                <div class="text-xs text-pink-200 uppercase tracking-widest">System Status</div>
                <div class="flex items-center justify-end gap-2 mt-1">
                    <span class="w-3 h-3 bg-green-400 rounded-full animate-pulse shadow-[0_0_10px_#4ade80]"></span>
                    <span class="font-bold text-white shadow-sm">Operational</span>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Container List -->
            <div class="lg:col-span-1 space-y-6">
                <div class="glass rounded-3xl p-6 h-full min-h-[500px] flex flex-col">
                    <h2 class="text-xl font-bold mb-6 text-white flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                        Missions
                    </h2>
                    <div id="container-list" class="space-y-3 flex-1 overflow-y-auto pr-2">
                        <!-- Container Items Injected Here -->
                        <div class="animate-pulse flex items-center justify-center h-40 text-pink-200">
                            Waiting for agent telemetry...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Details & Charts -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="glass-card rounded-2xl p-5">
                        <div class="text-pink-100 text-xs uppercase tracking-wider mb-1">CPU Usage</div>
                        <div id="stat-cpu" class="text-3xl font-bold text-white drop-shadow-sm">--</div>
                    </div>
                    <div class="glass-card rounded-2xl p-5">
                        <div class="text-pink-100 text-xs uppercase tracking-wider mb-1">Memory Usage</div>
                        <div id="stat-mem" class="text-3xl font-bold text-white drop-shadow-sm">--</div>
                    </div>
                    <div class="glass-card rounded-2xl p-5">
                        <div class="text-pink-100 text-xs uppercase tracking-wider mb-1">Security Score</div>
                        <div id="stat-sec" class="text-3xl font-bold text-white drop-shadow-sm">--</div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="glass rounded-3xl p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-white">Neural Prediction Engine</h3>
                        <span class="text-xs bg-white/20 px-2 py-1 rounded text-white">Live Feed</span>
                    </div>
                    <canvas id="resourceChart" height="200"></canvas>
                </div>

                <!-- Security Risks -->
                <div id="security-panel" class="glass rounded-3xl p-6 hidden border-red-400/30">
                    <h3 class="text-lg font-bold mb-4 text-red-100 flex items-center gap-2">
                        <svg class="w-5 h-5 text-red-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        Security Threats Detected
                    </h3>
                    <ul id="risk-list" class="space-y-2 text-red-50 text-sm">
                    </ul>
                </div>

                <!-- Evaluation Panel -->
                <div class="glass rounded-3xl p-6 mt-6">
                    <div class="flex justify-between items-end mb-4">
                        <div>
                            <h3 class="text-lg font-bold text-orange-100">Lab Evaluation</h3>
                            <p class="text-xs text-pink-200 max-w-sm mt-1">Run comparative analysis between Static Limits and AI-Driven Dynamic Scaling.</p>
                        </div>
                        <button onclick="runEvaluation()" class="bg-white/20 hover:bg-white/30 border border-white/40 text-white px-5 py-2.5 rounded-xl font-semibold transition shadow-lg backdrop-blur-sm text-sm">
                            Results Comparison
                        </button>
                    </div>
                    
                    <div id="eval-loading" class="hidden text-pink-200 text-sm animate-pulse flex items-center gap-2">
                        <svg class="animate-spin h-4 w-4 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        Running simulation scenarios (20s)...
                    </div>
                    
                    <table id="eval-table" class="w-full text-sm text-left hidden mt-4">
                        <thead class="text-xs uppercase bg-white/10 text-pink-100">
                            <tr>
                                <th class="px-4 py-3 rounded-l-lg">Scenario</th>
                                <th class="px-4 py-3">Mode</th>
                                <th class="px-4 py-3">Efficiency</th>
                                <th class="px-4 py-3 rounded-r-lg">OOM Kills</th>
                            </tr>
                        </thead>
                        <tbody id="eval-body" class="text-white"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Background Decoration -->
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-purple-500/30 rounded-full blur-[100px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-orange-400/30 rounded-full blur-[100px]"></div>
    </div>

    <script>
        // Set Chart Defaults for Glassmorphism
        Chart.defaults.color = 'rgba(255, 255, 255, 0.7)';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
        
        const ctx = document.getElementById('resourceChart').getContext('2d');
        
        // Gradient for Chart
        let gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(255, 255, 255, 0.5)');
        gradient.addColorStop(1, 'rgba(255, 255, 255, 0.05)');

        const resourceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'CPU Usage',
                    data: [],
                    borderColor: '#ffffff',
                    backgroundColor: gradient,
                    borderWidth: 2,
                    pointBackgroundColor: '#ffffff',
                    pointRadius: 3,
                    fill: true,
                    tension: 0.4
                }, {
                    label: 'AI Quota Limit',
                    data: [],
                    borderColor: 'rgba(255, 255, 255, 0.4)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { usePointStyle: true, boxWidth: 8 }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { callback: function(value) { return value / 1000 + 'ms'; } }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });

        let selectedContainer = null;

        async function fetchStats() {
            try {
                const res = await fetch('/api/stats');
                const data = await res.json();
                updateUI_MultiNode(data);
            } catch (e) {
                console.error("Failed to fetch stats");
            }
        }

        async function fetchSecurity(id) {
            if (!id || id.length > 20) return; // ignore complex IDs if not necessary
            try {
                const res = await fetch(`/api/security/${id}`);
                const data = await res.json();
                updateSecurityUI(data);
            } catch (e) {
               console.error("Sec scan fail");
            }
        }

        function updateUI_MultiNode(nodes) {
            const listEl = document.getElementById('container-list');
            // We rebuild list only if changes to avoid jitter, or simple verify
            // For prototype simplicity, clear and rebuild is fine but we must preserve selection logic visually
            listEl.innerHTML = '';

            Object.keys(nodes).forEach(nodeId => {
                const nodeData = nodes[nodeId];
                
                // Header for Node
                const nodeHeader = document.createElement('div');
                nodeHeader.className = "text-xs font-bold text-pink-200/60 uppercase mt-4 mb-2 pl-2 tracking-wider";
                nodeHeader.innerText = `Node: ${nodeId}`;
                listEl.appendChild(nodeHeader);

                Object.keys(nodeData.containers).forEach(containerId => {
                    const c = nodeData.containers[containerId];
                    const isSel = selectedContainer === (c.id || containerId);
                    
                    const item = document.createElement('div');
                    item.className = `p-4 rounded-xl cursor-pointer mb-2 transition-all duration-200 border border-transparent ${isSel ? 'bg-white/20 border-white/40 shadow-lg' : 'bg-white/5 hover:bg-white/10 hover:translate-x-1'}`;
                    item.onclick = () => selectContainer(c.id || containerId, c);
                    item.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div class="font-bold text-sm truncate text-white">${(c.id || containerId).substring(0, 12)}...</div>
                            <div class="w-2 h-2 rounded-full ${isSel ? 'bg-white' : 'bg-white/30'}"></div>
                        </div>
                        <div class="flex justify-between mt-2 text-xs text-pink-100/70">
                            <span>CPU: ${c.cpu_usage || 0}</span>
                            <span>${Math.round((c.memory_bytes||0) / 1024 / 1024)}MB</span>
                        </div>
                    `;
                    listEl.appendChild(item);

                    // Update charts if selected
                    if (isSel) {
                        updateCharts(c);
                    }
                });
            });
            
            // Auto-select first if none selected
            if (!selectedContainer) {
                 const firstNode = Object.keys(nodes)[0];
                 if (firstNode) {
                     const firstCont = Object.keys(nodes[firstNode].containers)[0];
                     if (firstCont) {
                         selectContainer(firstCont, nodes[firstNode].containers[firstCont]);
                     }
                 }
            }
        }
        
        function updateCharts(c) {
            document.getElementById('stat-cpu').innerText = c.cpu_usage;
            document.getElementById('stat-mem').innerText = `${Math.round((c.memory_bytes||0) / 1024 / 1024)} MB`;
            
            const timeLabel = new Date().toLocaleTimeString();
            
            // Limit data points
            if (resourceChart.data.labels.length > 30) {
                resourceChart.data.labels.shift();
                resourceChart.data.datasets[0].data.shift();
                resourceChart.data.datasets[1].data.shift();
            }

            resourceChart.data.labels.push(timeLabel);
            resourceChart.data.datasets[0].data.push(c.cpu_usage);
            resourceChart.data.datasets[1].data.push(c.prediction || c.cpu_usage); 
            resourceChart.update('none'); // 'none' for performance
        }

        function selectContainer(id, data) {
            selectedContainer = id;
            if (data) fetchSecurity(id);
            // Don't clear chart immediately to avoid flicker, just let next update cycle handle it 
            // or clear if completely different context desired.
            // But we do want to verify data matches if we switched.
        }
        
        function updateSecurityUI(data) {
            const scoreEl = document.getElementById('stat-sec');
            const panel = document.getElementById('security-panel');
            const list = document.getElementById('risk-list');

            if (!data) return;

            scoreEl.innerText = data.score;
            // Color code
            if(data.score >= 90) scoreEl.className = "text-3xl font-bold text-green-300 drop-shadow-sm";
            else if(data.score >= 70) scoreEl.className = "text-3xl font-bold text-yellow-300 drop-shadow-sm";
            else scoreEl.className = "text-3xl font-bold text-red-300 drop-shadow-sm";

            if (data.risks && data.risks.length > 0) {
                panel.classList.remove('hidden');
                list.innerHTML = data.risks.map(r => `
                    <li class="flex items-start gap-2 bg-red-500/10 p-2 rounded">
                        <span class="mt-1 w-1.5 h-1.5 bg-red-400 rounded-full flex-shrink-0"></span>
                        ${r}
                    </li>`).join('');
            } else {
                panel.classList.add('hidden');
            }
        }

        async function runEvaluation() {
            document.getElementById('eval-loading').classList.remove('hidden');
            document.getElementById('eval-table').classList.add('hidden');
            try {
                const res = await fetch('/api/run_evaluation');
                const data = await res.json();
                
                const tbody = document.getElementById('eval-body');
                tbody.innerHTML = '';
                
                data.forEach(row => {
                   const tr = document.createElement('tr');
                   const isDyn = row.Mode === 'dynamic';
                   tr.className = "border-b border-white/10 last:border-0 hover:bg-white/5 transition";
                   tr.innerHTML = `
                      <td class="px-4 py-3 font-medium">${row.Scenario}</td>
                      <td class="px-4 py-3 uppercase text-xs font-bold tracking-wider ${isDyn ? 'text-green-300' : 'text-orange-300'}">
                        <span class="px-2 py-1 rounded bg-white/10">${row.Mode}</span>
                      </td>
                      <td class="px-4 py-3 font-mono">${row.Efficiency_Percent}%</td>
                      <td class="px-4 py-3 ${row.OOM_Kills > 0 ? 'text-red-300 font-bold' : 'text-white/50'}">${row.OOM_Kills}</td>
                   `;
                   tbody.appendChild(tr);
                });
                
                document.getElementById('eval-loading').classList.add('hidden');
                document.getElementById('eval-table').classList.remove('hidden');

            } catch(e) {
                console.error(e);
                alert("Evaluation failed");
                document.getElementById('eval-loading').classList.add('hidden');
            }
        }

        // Poll every 2 seconds
        setInterval(fetchStats, 2000);
        // Initial load
        fetchStats();
    </script>
</body>
</html>
